# TODO

- [ ] Layer merge button should only be active when possible (i.e. multiple layers are selected).
- [ ] Brief look at how to set up file association on linux - seems like no great way to do automatically, maybe appimage or deb have something? Otherwise users can just do it. Does [this spec](https://specifications.freedesktop.org/shared-mime-info-spec/latest/ar01s02.html) cover it?
- [ ] Clear out random todos, notes etc.
- [ ] Look at publishing releases to crates.io to allow cargo install, e.g. [see this discussion](https://users.rust-lang.org/t/does-anyone-use-github-actions-to-run-cargo-publish/92374/4)
- [ ] Automated release notes, see [release drafter](https://github.com/marketplace/actions/release-drafter), [this discussion](https://users.rust-lang.org/t/does-anyone-use-github-actions-to-run-cargo-publish/92374/4)].
- [ ] Update README, look at moving web stuff to separate doc, add installation instructions with link to github releases, when crate is published add instructions for installing with cargo.
- [ ] Fix missing file icon, dependent on [this issue](https://github.com/crabnebula-dev/cargo-packager/issues/372). That covers macOS and Windows, not sure on Linux?
- [ ] Option when creating a new map to duplicate selected map (or maybe three options - one to duplicate map completely, one to just create matching layers but empty, one to create a map with just a default empty layer)
- [ ] Support multiple files open? Copy/paste may be interesting, need to translate tilesets by looking up in source project, and seeing if there is a matching file path in the target - maybe start from full absolute path match, then if not check for file name match, then tileset name match, if none match or there are multiple (since names don't have to be unique) prompt user.
- [ ] Intelligent squashing of color layers when importing a Tiled file with expected properties. Might be best to be relatively lax - just use the first layer with each Tiled property layer name as a target to squash all layers with this property layer name into it. For Tiled layers with no property, squash into a new layer called "Default"? This should give a perfect round trip when exporting Tiled then immediately reimporting, and will still do something fairly useful if layers are edited in Tiled.
- [ ] TilesetMode with bg/fg colors. Will need to move to new struct to pass to loader, which specifies that one color will be set to white and everything else transparent. Then we can do a single layer with bg/fg colors for ascii art type stuff. "ForegroundAndBackgroundColor" will accept two colors, and will process images to a pair of textures - the fg texture will have the fg color replaced with white and everything else set to transparent, the bg texture will do the same with the bg color. It's expected that images will only have these two colors, probably as black and white, but other images will work. When used, the tile will draw two quads, one using fg texture with one (fg) tint color, and one with bg texture and tint. This will need adding a new optional color to tiles for the bg (main color is used for fg), this color is only used when combined with a tileset with required color handling).
- [ ] Use +/- shortcuts for zoom, move tileset selection shortcuts elsewhere?
- [ ] Make layer shortcuts cycle from last to first and vice versa.
- [ ] Make layer selection shortcuts work when all layers are selected - select first layer for "up" and last layer for "down" instead of doing nothing. Allows shortcut-only toggling between one layer and all layers.
- [ ] Convert relative paths to absolute and back again when "Save As.." changes file location? Could alternatively offer to copy images to new location?
- [ ] Make drag selection use I32Pos2, and track drag outside map, but only select when it enters drag (e.g. stop selecting along the edge of map when dragging outside).
- [ ] Hint when trying to cut/copy and there is nothing on the selected layer(s)
- [ ] Hint when trying to draw and the selected layers only have blank layers in stamp?
- [ ] Store recent files in app state, show in file menu
- [ ] Option to export selection only, for png export. Use bounding box of current selection, disabled if there is no selection.
- [ ] Run render to png in a background thread, e.g using [std::sync::mpsc](https://doc.rust-lang.org/rust-by-example/std_misc/channels.html) to pass data to thread and then notification on complete. Look at [`repaint_signal`](https://github.com/emilk/egui/issues/82), looks like this can be cloned and sent to the other thread, so egui->bg would look like a clone of the stuff to render, plus that signal, then on completing the render it would send a message bg -> egui saying what had happened (just something like `Result<(), RenderError>` now, but could do other stuff in future, e.g. send back progress percentage to display in dialog), and then (AFTER sending the message) would call the repaint signal. Egui would repaint, and on each repaint should do a non-blocking poll for messages and handle them, handling the render message would be just closing an "export in progress" dialog and displaying an error dialog if there's an error. This approach should be extensible to other stuff in future as needed.
- [ ] Catch all ways of closing app (on macos: cmd+q, macos menu "Quit", clicking close button on window) and prompt for data loss (in same way as when using file->quit "soft" menu). The window close button can be handled following [this example](https://github.com/emilk/egui/blob/0.31.1/examples/confirm_exit/src/main.rs) but this doesn't seem to work for cmd+q. Is [this winit issue](https://github.com/rust-windowing/winit/issues/41) relevant? Have created an [egui issue](https://github.com/emilk/egui/issues/7115)
- [ ] Special handling for selection in tileset ui when current selection is based on a stamp? We would essentially just clear the selection when we see a drag start, if the current selection is from stamp.
- [ ] MacOS File association, open file in new or existing app instance. See [this issue](https://github.com/rust-windowing/winit/issues/4260) which seems to indicate that this won't be possible until egui moves to winit 0.31 (looks like this is needed to allow [setting up an AppDelegate](https://github.com/rust-windowing/winit/pull/3758) to receive events on file open. Might also be possible at that point to use real menus on macos?). More details on [this issue](https://github.com/rust-windowing/winit/issues/2190)
- [ ] "Void" as a color - this is just not drawn at all. Can be faster than a 0 alpha color since we can skip drawing completely. On lightbox, also picks up glow from neighbouring pixels with actual colors. Note this is not part of palette - it's a separate color like default. Add this to UI as say a cross in a black box, and tweak palette selection so it's an enum, Void/Palette(u32) (could add default later as well).
- [ ] Sparse tiles in layers? We should keep same file format if possible, to make it easier to interpret, and to move between internal representations - this will just be there to reduce memory usage for sparsely filled maps. In theory could later have "infinite" maps, in short term might be more compact than current approach, plus easier to resize. For performance, consider storing maps as blocks of a reasonable number of tiles (e.g. 8x8), with blocks stored in a map by top-left corner position. Then we can just create blocks as they are needed to save memory, but when drawing maps we can query by block and hopefully get good cache performance (actually probably better than current full vec, if we ever get round to only drawing visible tiles, since we'd get blocks together in memory, rather than whole lines which could go off screen).
- [ ] Reduce undo memory usage - maybe use a bidirectional delta format?
- [ ] Extend `[` and `]` shortcuts with shift modifier to extend selection rather than just moving?
- [ ] Allow "squash" of layers when pasting? When there are more stamp layers than selected+visible layers to paste into, we would paste all the extra layers, in order from bottom to top, into the top selected+visible layer, with later stamp layers replacing existing tiles (where the stamp layer tiles are not None). The most useful case would probably be pasting multiple stamp layers into a single map layer. This would probably have to be an optional setting, but could be just the default? It's a bit arbitrary when we are pasting say 4 stamp layers into 2 map layers - should we really do 1->1, then 2+3+4 -> 2, rather than some other arrangement?
- [ ] Add tests for selection, look at tests for other parts of `State` as well?
- [ ] Multiple project support - e.g. just have one `MainApp` struct per project, and allow switching between them, e.g. tabs on toolbar?
- [ ] Direct connection to USB display, e.g. to display live as CRT on a pico, or on a HUB75 panel? Would just send entire tilemap on each edit.
- [ ] Real menus with [muda](https://github.com/tauri-apps/muda)? On the other hand, might be better to just move away from menus completely and have as plain an interface as possible, with just shortcut keys and plain controls.
- [ ] Ratatui? [egui_ratatui](https://github.com/gold-silver-copper/egui_ratatui), [soft_ratatui](https://github.com/gold-silver-copper/soft_ratatui), [mousefood](https://github.com/j-g00da/mousefood) on embedded?
- [ ] [Taffy](https://github.com/PPakalns/egui_taffy/)?

## Done

- [x] Fix missing icon and window title on Ubuntu - added app id named to match desktop file (which is named after binary, which is named after crate). This fixes the issue at least on Bazzite using a ubuntu box, although it does require copying the .desktop file to `/var/~/.local/share/applications`, since it looks like boxbuddy/distro-box don't do this for you.
